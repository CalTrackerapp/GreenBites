# ADR-002: Database and Data Storage Strategy

## Status
Accepted

## Context
We needed to decide on a data storage solution for GreenBites that would handle:
- User profile data (gender, height, weight, goals)
- Food database (nutrition information, carbon footprint)
- Food logs (user meal entries with timestamps)
- Aggregated totals (daily/weekly calories, macros, CO₂)

Questions to consider:
- Where will user data be stored?
- How will it persist between sessions?
- What are the trade-offs of different approaches?
- How do we handle relational data (users → foodLogs → foods)?
- What about scalability and performance?

Key requirements:
- Type-safe database queries
- Migration system for schema evolution
- Cloud hosting for easy deployment
- Support for relational data
- Good developer experience

## Decision
We will use **PostgreSQL** as our database with **Drizzle ORM** for type-safe queries because:
1. Relational model fits our data structure (users, foods, foodLogs with foreign keys)
2. ACID compliance ensures data integrity
3. Strong ecosystem and tooling
4. Cloud hosting options (Supabase, Neon) provide free tiers for development

We will host on **Supabase or Neon** (cloud PostgreSQL) because:
1. Free tier sufficient for MVP
2. Automatic backups and scaling
3. Easy connection string management
4. No local database setup required
5. SSL support out of the box

We will use **Drizzle ORM** instead of raw SQL or other ORMs because:
1. Type-safe queries with TypeScript
2. Lightweight compared to Prisma
3. Migration system built-in
4. Good Next.js integration
5. Schema defined in TypeScript

## Consequences

### Positive
- Type safety prevents SQL injection and type errors
- Cloud hosting eliminates local setup complexity
- Drizzle migrations make schema changes easy
- Relational model enforces data integrity
- Free tier sufficient for development and MVP

### Negative
- Learning curve for Drizzle (less documentation than Prisma)
- Cloud database requires internet connection for development
- Potential latency for local development
- Migration from local to cloud required some rework

## Migration Plan

### Weeks 1-2: Initial Setup
- Drizzle ORM installation and configuration
- Schema design (users, foods, foodLog tables)
- Local PostgreSQL for initial development
- Basic CRUD operations

### Weeks 3-5: Services Layer
- Created services layer (`drizzle/src/services/`)
- Implemented user, food, and foodLog services
- Express API routes for database operations
- Testing with local database

### Weeks 6-7: API Integration
- Food logging with database persistence
- User totals calculation and updates
- Nutrition API integration with database storage

### Week 8: Next.js Migration
- Ported Express routes to Next.js API routes
- Maintained same database schema
- Updated service layer for Next.js

### Week 9-10: Cloud Migration
- Migrated from local PostgreSQL to Supabase
- Updated connection strings and environment variables
- Verified all functionality with cloud database
- Fixed schema issues (gender field type change)

## Alternatives Considered

### Option 1: MongoDB (NoSQL)
- **Pros**: Flexible schema, easy to start, good for rapid prototyping
- **Cons**: No built-in relationships, eventual consistency concerns
- **Decision**: Chose PostgreSQL for relational data integrity and ACID compliance

### Option 2: Prisma ORM
- **Pros**: More mature, excellent tooling, larger community
- **Cons**: Heavier, more opinionated, larger bundle size
- **Decision**: Chose Drizzle for lighter weight and better TypeScript integration

### Option 3: Local PostgreSQL Only
- **Pros**: No internet required, faster for development
- **Cons**: Setup complexity, not suitable for team collaboration, deployment issues
- **Decision**: Started local but migrated to cloud for team collaboration and deployment

### Option 4: Firebase/Supabase (NoSQL)
- **Pros**: Real-time capabilities, built-in auth (though we use Clerk)
- **Cons**: Less structured, harder to query complex relationships
- **Decision**: Chose PostgreSQL for structured relational data

## Notes
- Schema evolved during development (e.g., gender field changed from char to varchar)
- Initially used local PostgreSQL but migrated to Supabase in Week 10 for production readiness
- Drizzle migrations made schema changes straightforward
- Consider adding indexes for performance as data grows
- Future: May need to implement caching layer for frequently accessed food data
