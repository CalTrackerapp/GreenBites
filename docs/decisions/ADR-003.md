# ADR-003: Migration from Express.js to Next.js

## Status
Accepted

## Context
The project initially started with Express.js for API routes while using React for the frontend. As development progressed, we recognized several issues:
- Separate frontend and backend codebases
- CORS configuration needed
- More complex deployment setup
- Duplication of routing logic
- Team had to maintain two different server setups

By Week 8, we had:
- Working Express API routes in `drizzle/src/routes/`
- React frontend with Context API
- Clerk authentication integrated
- Database services layer working

The question arose: Should we continue with Express or migrate to Next.js for a unified full-stack solution?

## Decision
We will migrate from **Express.js to Next.js API Routes** because:
1. **Unified codebase** - Frontend and backend in one project
2. **Built-in API routes** - No need for separate Express server
3. **Better TypeScript integration** - Shared types between frontend and backend
4. **Simplified deployment** - Single deployment target (Vercel/Netlify)
5. **No CORS issues** - Same origin for API calls
6. **Next.js App Router** - Modern routing patterns
7. **Server components** - Potential for future optimizations

The migration will:
- Port Express routes to `app/api/` directory
- Maintain existing service layer (`drizzle/src/services/`)
- Update frontend API calls to use relative paths
- Remove Express server setup
- Keep database schema and Drizzle ORM unchanged

## Consequences

### Positive
- Simplified project structure
- Easier deployment (single build)
- Better developer experience with unified codebase
- No CORS configuration needed
- Type safety across frontend and backend
- Server-side rendering capabilities available
- Better performance with Next.js optimizations

### Negative
- Migration effort required (Week 8)
- Team had to learn Next.js API routes syntax
- Some rework of existing Express routes
- Temporary duplication during migration period
- Lost some Express-specific middleware patterns

## Implementation Timeline

### Week 8 (Oct 28-Nov 3)
- **Planning**: Analyzed existing Express routes and dependencies
- **Migration**: Ported routes from `drizzle/src/routes/` to `app/api/`
  - `/api/users` routes
  - `/api/users/[username]/foodLogs` routes
  - `/api/foods` routes
- **Updates**: Modified service layer calls to work with Next.js Request/Response
- **Testing**: Verified all API endpoints work with new structure
- **Cleanup**: Removed Express server files and dependencies

### Week 9 (Nov 4-10)
- **Refinement**: Updated AddMeal component to use Next.js routes
- **Integration**: Connected profile API routes
- **Fixes**: Resolved any remaining compatibility issues

## Alternatives Considered

### Option 1: Keep Express.js
- **Pros**: Team already familiar, working solution, no migration needed
- **Cons**: Separate codebases, CORS issues, complex deployment, maintenance overhead
- **Decision**: Rejected due to long-term maintenance and deployment complexity

### Option 2: Use Next.js from the Start
- **Pros**: Would have avoided migration, cleaner architecture from beginning
- **Cons**: Not applicable - decision made after initial setup
- **Decision**: Not applicable, but would have been preferred in hindsight

### Option 3: Keep Express but Use Next.js for Frontend Only
- **Pros**: Keep existing backend, gradual migration
- **Cons**: Still have two codebases, CORS issues remain, deployment complexity
- **Decision**: Rejected - doesn't solve the core problems

### Option 4: Use tRPC
- **Pros**: End-to-end type safety, great DX
- **Cons**: Additional learning curve, more opinionated, overkill for current needs
- **Decision**: Rejected - Next.js API routes sufficient for our needs

## Notes
- Migration was smoother than expected due to well-structured service layer
- Service layer (`drizzle/src/services/`) remained unchanged, only route layer changed
- Next.js API routes are simpler than Express for our use case
- Future: Could consider tRPC if we need more complex type-safe APIs
- The migration improved code organization and maintainability
- Team consensus: Migration was worth the effort for long-term benefits

